<!DOCTYPE html>
<html>
<head>
    <title>Tienda - Dulce Tentaci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #FFF5F8;
        }

        .header-principal {
            background-color: #F8BBD0;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 40px;
        }

        .card-postre {
            transition: transform 0.2s ease;
        }

        .card-postre:hover {
            transform: scale(1.03);
        }

        .btn-pastel {
            background-color: #F48FB1;
            color: white;
        }

        .btn-pastel:hover {
            background-color: #ec6fa5;
            color: white;
        }

        @keyframes bounce {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .animate-bounce {
        animation: bounce 0.3s ease;
        }

        .toast-personalizado {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #F48FB1;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s ease;
            z-index: 9999;
        }

        .toast-personalizado.mostrar {
            opacity: 1;
            transform: translateY(0);
        }

    </style>

</head>
<body>
    <div class="container mt-5">

        <div class="d-flex justify-content-end mb-3">
            <a href="/carrito" class="btn btn-pastel position-relative">
            üõí Carrito
                <span id="contadorCarrito" 
                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    0
                </span>
            </a>
        </div>

        <div class="header-principal shadow-sm">
            <h1>Dulce Tentaci√≥n üç∞</h1>
            <h2 id="nombre"></h2>
        </div>

        <h3 class="mb-4">Productos disponibles:</h3>

        <div id="listaProductos" class="row g-4"></div>

        <div class="mt-5 text-center">
            <a href="/logout" class="btn btn-outline-secondary">Cerrar sesi√≥n</a>
        </div>

    </div>

    <script>
        // Mostrar nombre
        fetch('/usuario')
        .then(res => res.json())
        .then(data => {
            document.getElementById('nombre').innerText = "Bienvenido, " + data.nombre + "üíï";
        });

        // Cargar productos
        fetch('/productos')
        .then(res => res.json())
        .then(productos => {
            const contenedor = document.getElementById('listaProductos');

            productos.forEach(prod => {
                console.log(prod);
                console.log("Imagen:", prod.imagen);
                const col = document.createElement("div");
                col.className = "col-md-4";

                col.innerHTML = `
                    <div class="card shadow-sm card-postre h-100">
                            <img src="/imagenes/${prod.imagen}"
                            class="card-img-top" 
                            style="height:200px; object-fit:cover;">
                        <div class="card-body text-center">
                            <h5 class="card-title">${prod.nombre}</h5>
                            <p class="card-text">Precio: <strong>$${prod.precio || 0}</strong></p>
                            <button class="btn btn-pastel w-100">
                                Agregar al carrito
                            </button>
                        </div>
                    </div>
                `;
                
                const boton = col.querySelector("button");
                boton.addEventListener("click", () => {
                    agregarAlCarrito(prod.id);
                });

                contenedor.appendChild(col);

            });
        });

        function actualizarContadorCarrito() {
            fetch('/api/carrito')
            .then(res => res.json())
            .then(carrito => {

                let totalItems = 0;

                carrito.forEach(item => {
                    totalItems += item.cantidad;
                });

                const badge = document.getElementById("contadorCarrito");

                if (totalItems === 0) {
                    badge.style.display = "none";
                } else {
                    badge.style.display = "inline-block";
                    badge.innerText = totalItems;

            
                    badge.classList.add("animate-bounce");
                    setTimeout(() => {
                        badge.classList.remove("animate-bounce");
                    }, 300);
                }
            });
        }
        
        function agregarAlCarrito(idProducto) {
            fetch('/agregar-carrito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    producto_id: idProducto,
                    cantidad: 1
                })
            })
            .then(res => res.json())
            .then(data => {
                actualizarContadorCarrito();
                mostrarToast();
            });
        }

        
        function mostrarToast() {
            const toast = document.getElementById("toastCarrito");

            toast.classList.add("mostrar");

            setTimeout(() => {
                toast.classList.remove("mostrar");
            }, 2000);
        }

    </script>

    <div id="toastCarrito" class="toast-personalizado">
        ‚úî Producto agregado al carrito
    </div>

</body>
</html>
